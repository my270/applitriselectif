<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#5b9cff" />
  <title>Tri‚ÄëS√©lectif Cam üéØ</title>

  <!-- D√©pendances: TFJS DOIT √™tre charg√© AVANT teachablemachine-image -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <!-- Confettis fun -->
  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg1:#0f172a; /* slate-900 */
      --bg2:#1e293b; /* slate-800 */
      --accent:#60a5fa; /* blue-400 */
      --good:#22c55e; /* green-500 */
      --warn:#f59e0b; /* amber-500 */
      --bad:#ef4444; /* red-500 */
      --card:#111827ee; /* gray-900 */
      --text:#e5e7eb; /* gray-200 */
      --muted:#9ca3af; /* gray-400 */
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #1d4ed8 0, transparent 60%),
                  radial-gradient(900px 700px at 120% 10%, #0ea5e9 0, transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:900px; margin:0 auto; padding:calc(env(safe-area-inset-top,0) + 24px) 16px 24px;}
    header{display:flex; align-items:center; gap:12px;}
    header .logo{width:42px; height:42px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg,#93c5fd,#60a5fa); box-shadow:0 10px 30px #60a5fa33; font-size:22px;}
    h1{font-size:clamp(22px,3.5vw,34px); margin:0; letter-spacing:.2px;}
    .sub{color:var(--muted); margin-top:4px;}

    .card{margin-top:18px; background:var(--card); border:1px solid #ffffff1a; border-radius:18px; box-shadow:0 20px 60px #0006; overflow:hidden;}
    .toolbar{display:flex; gap:12px; padding:14px; background:linear-gradient(180deg, #ffffff10, #00000000); align-items:center; flex-wrap:wrap;}
    button.primary{
      appearance:none; border:none; border-radius:14px; padding:12px 16px; font-weight:700; color:#0b1220;
      background:linear-gradient(135deg,#93c5fd,#60a5fa); box-shadow:0 10px 30px #60a5fa44; cursor:pointer;
    }
    button.secondary{appearance:none; border:1px solid #ffffff2a; background:#0b1220; color:var(--text); border-radius:14px; padding:12px 16px;}
    button:disabled{opacity:.6; cursor:not-allowed;}

    .stage{display:grid; grid-template-columns:1fr;}
    #webcam-container, #preview{
      width:100%; aspect-ratio: 1 / 1; background:#0b1220; display:grid; place-items:center;
    }
    #webcam-container canvas, #preview video, #preview img{ width:100%; height:100%; object-fit:cover;}

    .result{padding:16px; display:grid; gap:10px;}
    .badge{display:inline-flex; align-items:center; gap:8px; background:#ffffff12; border:1px solid #ffffff24; padding:6px 10px; border-radius:999px; font-size:14px;}
    .big{font-size: clamp(22px, 4.5vw, 36px); font-weight:800; letter-spacing:.3px;}
    .progress{height:14px; background:#ffffff14; border:1px solid #ffffff20; border-radius:999px; overflow:hidden;}
    .bar{height:100%; width:0%; transition: width .25s ease;}
    .pct{font-variant-numeric: tabular-nums; opacity:.9}
    .hint{color:var(--muted); font-size:14px;}

    footer{padding:16px; color:#aab0b7; font-size:12px; text-align:center}
    a{color:#cfe4ff}

    details.tests{margin-top:16px;}
    details.tests summary{cursor:pointer;}
    .ok{color:#22c55e}
    .ko{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">‚ôªÔ∏è</div>
      <div>
        <h1>Tri‚ÄëS√©lectif Cam</h1>
        <div class="sub">Pointe la cam√©ra vers un d√©chet et je te dis o√π le trier.</div>
      </div>
    </header>

    <div class="card">
      <div class="toolbar">
        <button id="startBtn" class="primary">üì∑ Ouvrir la cam√©ra</button>
        <button id="switchBtn" class="secondary" disabled>üîÅ Basculer cam√©ra</button>
        <button id="uploadBtn" class="secondary">üñºÔ∏è Photo depuis la galerie</button>
        <input type="file" id="fileInput" accept="image/*" capture="environment" hidden>
        <div class="badge" id="modelStatus">Mod√®le : <strong>non charg√©</strong></div>
      </div>

      <div class="stage">
        <div id="webcam-container"></div>
        <div id="preview" hidden></div>
      </div>

      <div class="result">
        <div class="badge"><span id="emoji">ü§î</span> <span id="label">En attente‚Ä¶</span></div>
        <div class="big"><span id="className">‚Äî</span></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div><span class="pct" id="pct">0%</span></div>
        <div class="hint" id="hint">Astuce¬†: reste stable 1‚Äì2¬†s pour une meilleure d√©tection.</div>
      </div>
    </div>

    <details class="tests">
      <summary>üß™ Autotests / diagnostic (clique pour d√©rouler)</summary>
      <div id="testsOut" style="padding:12px 0"></div>
      <button id="runTests" class="secondary">Lancer les tests</button>
    </details>

    <footer>
      Fait avec <a href="https://teachablemachine.withgoogle.com/" target="_blank" rel="noopener">Teachable Machine</a> & TensorFlow.js ‚Ä¢ Fonctionne sur mobile (HTTPS requis pour la cam√©ra)
    </footer>
  </div>

  <script>
    // ====== Configuration ======
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/OcZJIo9wh/"; // mod√®le fourni

    // Emojis par classe ‚Äî adapte aux labels exacts de TON mod√®le (casse/accents inclus)
    const EMOJI_BY_CLASS = {
      "plastique":"üß¥",
      "papier":"üìÑ",
      "carton":"üì¶",
      "verre":"üçæ",
      "m√©tal":"ü•´",
      "metal":"ü•´",
      "organique":"üçå",
      "d√©chet":"üóëÔ∏è",
      "dechet":"üóëÔ∏è"
    };

    let model, maxPredictions, webcam;
    let usingWebcam = false;

    const el = {
      startBtn: document.getElementById('startBtn'),
      switchBtn: document.getElementById('switchBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      fileInput: document.getElementById('fileInput'),
      webcamContainer: document.getElementById('webcam-container'),
      preview: document.getElementById('preview'),
      modelStatus: document.getElementById('modelStatus'),
      label: document.getElementById('label'),
      className: document.getElementById('className'),
      bar: document.getElementById('bar'),
      pct: document.getElementById('pct'),
      emoji: document.getElementById('emoji'),
      hint: document.getElementById('hint'),
      testsOut: document.getElementById('testsOut'),
      runTests: document.getElementById('runTests'),
    };

    // S√©curit√©: s'assurer que les libs sont pr√©sentes AVANT usage
    function libsReady(){
      return typeof window !== 'undefined' && window.tf && window.tmImage && typeof tmImage.load === 'function';
    }

    // ‚Äî‚Äî‚Äî Chargement du mod√®le au premier usage
    async function ensureModelLoaded(){
      if(model) return;
      if(!libsReady()){
        el.modelStatus.innerHTML = 'Mod√®le : <strong>‚ùå biblioth√®ques manquantes</strong>';
        console.error('Biblioth√®ques non pr√™tes', { tf: !!window.tf, tmImage: !!window.tmImage });
        alert('Les biblioth√®ques TFJS / TeachableMachine ne sont pas charg√©es. V√©rifie ta connexion.');
        throw new Error('Librairies non charg√©es');
      }
      try {
        el.modelStatus.innerHTML = 'Mod√®le : <strong>chargement‚Ä¶</strong>';
        // Assure un backend utilisable m√™me si WebGL est bloqu√©
        try {
          await tf.ready();
          const backends = tf.engine().registryFactory ? Object.keys(tf.engine().registryFactory) : [];
          if(tf.backend().name !== 'webgl' && backends.includes('webgl')){
            await tf.setBackend('webgl');
          }
        } catch (e) {
          try { await tf.setBackend('cpu'); } catch(_){}
        }
        model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
        maxPredictions = model.getTotalClasses();
        el.modelStatus.innerHTML = 'Mod√®le : <strong>‚úÖ pr√™t</strong>';
      } catch(e){
        console.error(e);
        el.modelStatus.innerHTML = 'Mod√®le : <strong>‚ùå erreur</strong>';
        alert("Impossible de charger le mod√®le. V√©rifie l'URL ou ta connexion.");
        throw e;
      }
    }

    // ‚Äî‚Äî‚Äî D√©marrer la cam√©ra
    async function startCamera(){
      await ensureModelLoaded();
      try{
        const flip = true; // flip horizontal (utile en selfie)
        webcam = new tmImage.Webcam(320, 320, flip);
        await webcam.setup({ facingMode: { ideal: 'environment' } });
        await webcam.play();
        usingWebcam = true;
        el.switchBtn.disabled = false;
        el.preview.hidden = true;
        el.webcamContainer.innerHTML = '';
        el.webcamContainer.appendChild(webcam.canvas);
        requestAnimationFrame(loop);
        el.hint.textContent = 'Conseil¬†: rapproche-toi et assure un bon √©clairage.';
      }catch(e){
        console.error(e);
        alert('Acc√®s cam√©ra refus√© ou indisponible. Utilise la galerie avec le bouton Photo.');
      }
    }

    // ‚Äî‚Äî‚Äî Boucle d'inf√©rence
    async function loop(){
      if(!usingWebcam) return;
      webcam.update();
      await predictSource(webcam.canvas);
      requestAnimationFrame(loop);
    }

    // ‚Äî‚Äî‚Äî Pr√©dire √† partir d'une source (canvas / image)
    async function predictSource(source){
      if(!model) return;
      const preds = await model.predict(source);
      preds.sort((a,b)=> b.probability - a.probability);
      const top = preds[0];
      const p = Math.round(top.probability * 100);
      el.className.textContent = top.className || 'Inconnu';
      el.pct.textContent = p + '%';
      el.bar.style.width = p + '%';
      el.bar.style.background = p>85? 'linear-gradient(90deg, var(--good), #4ade80)': p>60? 'linear-gradient(90deg, var(--warn), #fbbf24)': 'linear-gradient(90deg, var(--bad), #f87171)';
      const key = (top.className||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
      const emoji = EMOJI_BY_CLASS[top.className?.toLowerCase()] || EMOJI_BY_CLASS[key] || (p>85?'‚úÖ':'ü§î');
      el.emoji.textContent = emoji;
      el.label.textContent = p>85? 'Je suis s√ªr¬∑e¬†!': p>60? 'Assez probable‚Ä¶' : 'Pas tr√®s s√ªr¬∑e';

      if(p > 90 && document.visibilityState === 'visible'){
        try{ navigator.vibrate?.(50); }catch{}
        confetti({ particleCount: 24, spread: 40, origin: { y: .85 }, scalar:.7 });
      }
    }

    // ‚Äî‚Äî‚Äî Basculer entre cam√©ras (si dispo)
    async function switchCamera(){
      try{
        if(!webcam) return;
        await webcam.stop();
        const track = webcam.stream?.getVideoTracks?.()[0];
        const current = track?.getSettings?.().facingMode || 'environment';
        const next = current === 'user' ? { ideal: 'environment' } : 'user';
        await webcam.setup({ facingMode: next });
        await webcam.play();
      }catch(e){ console.warn('Switch cam error', e); }
    }

    // ‚Äî‚Äî‚Äî Upload depuis la galerie
    function openFile(){ el.fileInput.click(); }

    el.fileInput.addEventListener('change', async (ev)=>{
      await ensureModelLoaded();
      const file = ev.target.files?.[0];
      if(!file) return;
      usingWebcam = false;
      try{ await webcam?.stop?.(); }catch{}
      const url = URL.createObjectURL(file);
      el.preview.hidden = false;
      el.webcamContainer.innerHTML = '';
      el.preview.innerHTML = '';
      const img = new Image();
      img.onload = async ()=>{
        el.preview.appendChild(img);
        await predictSource(img);
      };
      img.src = url;
      el.hint.textContent = 'Tu peux reprendre la cam√©ra quand tu veux.';
    });

    // ‚Äî‚Äî‚Äî Tests / Diagnostic
    function print(line, ok){
      const p = document.createElement('div');
      p.innerHTML = (ok? '<span class="ok">‚úî</span>':'<span class="ko">‚úñ</span>') + ' ' + line;
      el.testsOut.appendChild(p);
    }

    async function runDiagnostics(){
      el.testsOut.innerHTML='';
      // Test 1: libs charg√©es
      print('TFJS charg√©: ' + (!!window.tf), !!window.tf);
      print('tmImage charg√©: ' + (!!window.tmImage), !!window.tmImage);
      print('tmImage.load dispo: ' + (window.tmImage && typeof tmImage.load==='function'), window.tmImage && typeof tmImage.load==='function');

      // Test 2: fetch metadata.json
      try{
        const res = await fetch(MODEL_URL + 'metadata.json', {cache:'no-store'});
        print('metadata.json accessible (HTTP '+res.status+')', res.ok);
        if(res.ok){
          const meta = await res.json();
          print('metadata contient des labels: ' + Array.isArray(meta?.labels), Array.isArray(meta?.labels));
        }
      }catch(e){ print('metadata.json inaccessible: ' + e.message, false); }

      // Test 3: chargement minimal du mod√®le
      try{
        await ensureModelLoaded();
        print('Chargement du mod√®le OK', true);
      }catch(e){ print('Chargement du mod√®le √âCHEC: '+e.message, false); }
    }

    // ‚Äî‚Äî‚Äî Events UI
    el.startBtn.addEventListener('click', startCamera);
    el.switchBtn.addEventListener('click', switchCamera);
    el.uploadBtn.addEventListener('click', openFile);
    el.runTests.addEventListener('click', runDiagnostics);

    // Pr√©‚Äëcharge silencieuse (et v√©rification de backend)
    window.addEventListener('load', async ()=>{
      // Attendre que les <script defer> soient ex√©cut√©s
      const start = performance.now();
      const timeout = 5000;
      while(!libsReady() && performance.now()-start < timeout){
        await new Promise(r=>setTimeout(r, 50));
      }
      if(libsReady()){
        // Lancer un pr√©‚Äëchargement non bloquant
        ensureModelLoaded().catch(()=>{});
      } else {
        console.warn('Biblioth√®ques non pr√™tes apr√®s attente');
      }
    });
  </script>
</body>
</html>
