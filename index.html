<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#5b9cff" />
  <title>Tri‑Sélectif Cam 🎯</title>

  <!-- Dépendances -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js?v=2"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js?v=2"></script>

  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --card:#111827ee; --text:#e5e7eb; --muted:#9ca3af;
    }
    html,body{height:100%; margin:0; font-family: system-ui, sans-serif; color:var(--text); background:linear-gradient(180deg, var(--bg1), var(--bg2));}
    .wrap{max-width:600px; margin:0 auto; padding:env(safe-area-inset-top) 8px 16px;}
    header{display:flex; align-items:center; gap:8px;}
    .logo{font-size:28px;}
    h1{margin:0; font-size:20px;}
    .sub{color:var(--muted); font-size:14px;}

    .card{margin-top:12px; background:var(--card); border-radius:12px; overflow:hidden;}
    .toolbar{display:flex; gap:8px; padding:8px; flex-wrap:wrap;}
    button{padding:8px 12px; border:none; border-radius:8px; font-size:14px; cursor:pointer;}
    .primary{background:#60a5fa; color:#000;}
    .secondary{background:#1e293b; color:var(--text);}

    .result{padding:8px; display:grid; gap:4px; position:sticky; top:0; background:rgba(15,23,42,0.95); z-index:2;}
    .badge{display:inline-flex; gap:6px; background:#ffffff12; padding:4px 8px; border-radius:999px; font-size:13px; align-items:center;}
    .big{font-size:18px; font-weight:bold;}
    .progress{height:10px; background:#ffffff14; border-radius:999px; overflow:hidden;}
    .bar{height:100%; width:0%; transition: width .25s ease;}
    .pct{font-size:12px;}
    .hint{font-size:12px; color:var(--muted);}

    .stage{width:100%;}
    #webcam-container, #preview{width:100%; max-width:100%; background:#0b1220; display:grid; place-items:center;}
    #webcam-container canvas, #preview img{width:100%; height:auto; max-height:45vh; object-fit:contain; image-rendering:auto; border-radius:8px;}

    footer{padding:12px; text-align:center; font-size:11px; color:#aab0b7;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">♻️</div>
    <div>
      <h1>Tri‑Sélectif Cam</h1>
      <div class="sub">Pointe la caméra vers un déchet et je te dis où le trier.</div>
    </div>
  </header>

  <div class="card">
    <div class="toolbar">
      <button id="startBtn" class="primary">📷 Ouvrir</button>
      <button id="switchBtn" class="secondary" disabled>🔁 Caméra</button>
      <button id="uploadBtn" class="secondary">🖼️ Galerie</button>
      <input type="file" id="fileInput" accept="image/*" capture="environment" hidden>
      <div class="badge" id="modelStatus">Modèle : <strong>non chargé</strong></div>
    </div>

    <div class="result">
      <div class="badge"><span id="emoji">🤔</span> <span id="label">En attente…</span></div>
      <div class="big" id="className">—</div>
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="pct" id="pct">0%</div>
      <div class="hint" id="hint">Astuce : reste stable pour de meilleurs résultats.</div>
    </div>

    <div class="stage">
      <div id="webcam-container"></div>
      <div id="preview" hidden></div>
    </div>

  <details class="tests" style="margin-top:10px;">
    <summary>🧪 Autotests / diagnostic</summary>
    <div id="testsOut" style="padding:8px 0"></div>
    <button id="runTests" class="secondary" type="button">Lancer les tests</button>
  </details>

  <footer>
    Fait avec <a href="https://teachablemachine.withgoogle.com/" target="_blank">Teachable Machine</a>
  </footer>
</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/OcZJIo9wh/";
const EMOJI_BY_CLASS = {"plastique":"🧴","papier":"📄","carton":"📦","verre":"🍾","métal":"🥫","metal":"🥫","organique":"🍌","déchet":"🗑️","dechet":"🗑️"};
let model, webcam, usingWebcam=false;

const el={startBtn:document.getElementById('startBtn'),switchBtn:document.getElementById('switchBtn'),uploadBtn:document.getElementById('uploadBtn'),fileInput:document.getElementById('fileInput'),webcamContainer:document.getElementById('webcam-container'),preview:document.getElementById('preview'),modelStatus:document.getElementById('modelStatus'),label:document.getElementById('label'),className:document.getElementById('className'),bar:document.getElementById('bar'),pct:document.getElementById('pct'),emoji:document.getElementById('emoji'),hint:document.getElementById('hint'),testsOut:document.getElementById('testsOut'),runTests:document.getElementById('runTests')};

function libsReady(){return window.tf && window.tmImage && typeof tmImage.load==='function';}
async function ensureModelLoaded(){if(model)return; if(!libsReady()){alert('Librairies non chargées'); throw new Error('libs');} el.modelStatus.innerHTML='Modèle : <strong>chargement…</strong>'; await tf.ready(); try{await tf.setBackend('webgl');}catch{await tf.setBackend('cpu');} model=await tmImage.load(MODEL_URL+'model.json', MODEL_URL+'metadata.json'); el.modelStatus.innerHTML='Modèle : <strong>✅ prêt</strong>';}

async function startCamera(){await ensureModelLoaded(); try{webcam=new tmImage.Webcam(320,320,true); await webcam.setup({facingMode:{ideal:'environment'}}); await webcam.play(); usingWebcam=true; el.switchBtn.disabled=false; el.preview.hidden=true; el.webcamContainer.innerHTML=''; el.webcamContainer.appendChild(webcam.canvas); requestAnimationFrame(loop);}catch(e){alert('Caméra indisponible');}}
async function loop(){if(!usingWebcam)return; webcam.update(); await predict(webcam.canvas); requestAnimationFrame(loop);}
async function predict(src){if(!model)return; const preds=await model.predict(src); preds.sort((a,b)=>b.probability-a.probability); const top=preds[0]; const p=Math.round(top.probability*100); el.className.textContent=top.className||'Inconnu'; el.pct.textContent=p+'%'; el.bar.style.width=p+'%'; el.bar.style.background=p>85?'var(--good)':p>60?'var(--warn)':'var(--bad)'; const key=top.className?.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); el.emoji.textContent=EMOJI_BY_CLASS[top.className?.toLowerCase()]||EMOJI_BY_CLASS[key]||'🤔'; el.label.textContent=p>85?'Je suis sûr·e !':p>60?'Assez probable…':'Pas sûr·e';}

async function switchCamera(){if(!webcam)return; await webcam.stop(); const track=webcam.stream?.getVideoTracks?.()[0]; const current=track?.getSettings?.().facingMode||'environment'; const next=current==='user'?{ideal:'environment'}:'user'; await webcam.setup({facingMode:next}); await webcam.play();}
function openFile(){el.fileInput.click();}
el.fileInput.addEventListener('change',async e=>{await ensureModelLoaded(); const file=e.target.files?.[0]; if(!file)return; usingWebcam=false; try{await webcam?.stop?.();}catch{} const url=URL.createObjectURL(file); el.preview.hidden=false; el.webcamContainer.innerHTML=''; el.preview.innerHTML=''; const img=new Image(); img.onload=async()=>{el.preview.appendChild(img); await predict(img);}; img.src=url;});

el.startBtn.addEventListener('click',startCamera);
el.switchBtn.addEventListener('click',switchCamera);
el.uploadBtn.addEventListener('click',openFile);
window.addEventListener('load',async()=>{const start=performance.now(); while(!libsReady() && performance.now()-start<5000){await new Promise(r=>setTimeout(r,50));} if(libsReady())ensureModelLoaded().catch(()=>{});} );

// ---------- Autotests
function print(line, ok){const p=document.createElement('div'); p.innerHTML=(ok?'<span style="color:#22c55e">✔</span>':'<span style="color:#ef4444">✖</span>')+' '+line; el.testsOut.appendChild(p);} 
el.runTests?.addEventListener('click', async ()=>{
  el.testsOut.innerHTML='';
  print('TFJS chargé: '+!!window.tf, !!window.tf);
  print('tmImage chargé: '+!!window.tmImage, !!window.tmImage);
  print('tmImage.load dispo: '+(window.tmImage && typeof tmImage.load==='function'), window.tmImage && typeof tmImage.load==='function');
  try{const res=await fetch(MODEL_URL+'metadata.json',{cache:'no-store'}); print('metadata.json HTTP '+res.status, res.ok);}catch(e){print('metadata.json erreur: '+e.message,false)}
  // Test responsivité: mesure hauteur réelle du canvas vs viewport
  const c=el.webcamContainer.querySelector('canvas');
  if(c){const vh=Math.round((c.clientHeight/window.innerHeight)*100); print('Hauteur vidéo ~'+vh+'vh (cible ≤45vh): '+(vh<=45), vh<=45);} else {print('Canvas non encore présent (ouvre la caméra pour tester la hauteur).', true)}
});
</script>
</body>
</html>
